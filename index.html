<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho&display=swap" rel="stylesheet">

    <title>èª¤å­—ãƒ­ãƒã®æ—¥è¨˜</title>
    <link rel="icon" href="diary-icon.png" type="image/png">
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333333;
            --border-color: #666666;
            --timeline-color: #666666;
            --highlight-color: #cccccc;
            --icon-size: 34px;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --transition: 0.2s ease;
        }

        body {
            font-family: "Zen Old Mincho", serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100svh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: relative;
            opacity: 0;
            transition: opacity var(--transition), background-color var(--transition);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        body.fake-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
        }

        .page-title,
        #page-title-inmodal,
        input[type="text"] {
            font-family: "Zen Old Mincho", serif;
            font-size: 18px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            text-decoration: none;
            user-select: none;
            z-index: 10;
        }

        .page-title,
        #page-title-inmodal {
            color: var(--text-color);
            background-color: #6363632f;
            padding: 5px 10px;
            opacity: 0.1;
        }

        .page-title:hover,
        #page-title-inmodal:hover,
        input[type="text"]:hover {
            opacity: 1;
        }

        .page-title {
            position: fixed;
            top: 10px;
            right: 20px;
        }

        .page-title.fake-mode {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .page-title.flash {
            background-color: #000 !important;
            color: #ff0 !important;
            border-color: #ff0 !important;
        }

        input[type="text"] {
            color: var(--text-color) !important;
            position: fixed;
            top: 10px;
            left: 20px;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            width: 7ic;
            opacity: .1;
            outline: none;
        }



        .diary-container-wrapper {
            width: 100%;
            max-width: 90%;
            height: 78vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            box-sizing: border-box;
            margin-top: 20px;
            transition: background-color var(--transition);
        }

        .diary-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            width: 100%;
            height: 100%;
            padding: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .diary-container::-webkit-scrollbar {
            display: none;
        }

        .diary-entry {
            writing-mode: vertical-rl;
            text-orientation: upright;
            line-height: 2;
            letter-spacing: 0.1em;
            width: auto;
            white-space: normal;
            overflow: visible;
            scroll-margin-top: 50px;
            padding: 0 10px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            text-wrap: balance;
            overflow-wrap: break-word;
            background-color: transparent;
            position: relative;
        }

        .date-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin: 0 20px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .date {
            font-size: 1.6em;
            cursor: pointer;
            white-space: nowrap;
        }

        .days-ago {
            font-size: 0.8em;
            margin-left: -3px;
            white-space: nowrap;
            opacity: 0.2;
        }

        .content {
            font-size: 1.3em;
            white-space: pre-line;
            text-wrap: balance;
            overflow-wrap: break-word;
        }

        .highlight {
            background-color: var(--highlight-color);
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            margin: 0 -2px;
        }

        .timeline-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 0 10%;
            box-sizing: border-box;
            touch-action: none;
        }

        @media (max-width: 768px) {
            .timeline-container {
                height: 20px;
            }
        }

        .timeline {
            position: relative;
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            align-items: flex-end;
            height: 100%;
            width: 100%;
            opacity: 0.1;
            transition: opacity var(--transition);
        }

        .timeline:hover {
            opacity: 1;
        }

        .timeline-bar {
            width: 6px;
            height: 100%;
            margin: 0 1px;
            background-color: transparent;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
        }

        .timeline-bar-inner {
            width: 100%;
            background-color: var(--text-color);
            transition: background-color var(--transition);
        }

        .timeline-bar:hover .timeline-bar-inner,
        .timeline-bar.selected .timeline-bar-inner {
            background-color: #00bc84 !important;
            opacity: 1 !important;
        }

        .icon {
            width: var(--icon-size);
            height: var(--icon-size);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            left:6px;
            transition: transform 0.1s, background-color var(--transition), filter var(--transition);
            border-radius: 4px;

        }

        .icon:hover {
            transform: scale(1.1);
            z-index: 20;
        }

        .icon.highlight {
            background-color: var(--highlight-color);
            filter: brightness(0.85);
        }

        .icon img,
        .icon-emoji {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
            font-size: x-large;
            filter: grayscale(100%);
            opacity: 0.2;
        }

        .icon:hover img,
        .icon:hover .icon-emoji {
            filter: grayscale(0%);
            opacity: 1;
        }

        .tooltip {
            position: absolute;
            top: -50%;
            left: 140%;
            transform: translateX(-50%);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid var(--border-color);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition);
            z-index: 30;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .icon:hover .tooltip {
            opacity: 1;
        }

        .info-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: none;
            background-color: #6363632f;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
            font-size: 18px;
            transition: all var(--transition);
            user-select: none;
            opacity: 0.2;
        }

        .info-button:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            visibility: hidden;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: skewY(-3deg) translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .modal-overlay.show .modal-content {
            transform: skewY(-3deg) translateY(0);
            opacity: 1;
        }

        .modal-inner {
            transform: skewY(3deg);
        }

        .modal-content h1,
        .modal-content h2,
        .modal-content p,
        .modal-content textarea {
            transform: skewY(-3deg);
        }

        .modal-content h1 {
            font-size: 1.8em;
            margin-top: 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .modal-content h2 {
            font-size: 1.3em;
            margin-top: 20px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
        }

        .modal-content p {
            line-height: 1.6;
            margin: 10px 0;
        }

        .modal-content input[type="text"] {
            position: static;
            width: 150px;
            margin: 0 5px;
            opacity: 1;
            border: none;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent;
            font-size: 1em;
            padding: 5px;
        }

        .modal-content textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 3px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            resize: vertical;
        }

        .modal-content img {
            display: block;
            margin: 15px auto;
        }

        .qr {
            max-width: 150px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-button,
        .share-button {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .modal-button:hover,
        .share-button:hover {
            opacity: 0.8;
        }

        .modal-button {
            margin: 0 10px;
        }

        .share-button {
            margin: 15px auto;
            display: block;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }

        .char.falling,
        .date.falling {
            position: fixed;
            transition: transform 2s ease-in, opacity 2s ease-out;
            will-change: transform, opacity;
            z-index: 100;
            pointer-events: none;
        }
    </style>

</head>

<body>
    <div class="page-title" id="pageTitle">èª¤å­—ãƒ­ãƒã®æ—¥è¨˜</div>
    <div class="diary-container-wrapper">
        <div class="diary-container" id="diaryContainer"></div>
    </div>
    <div class="timeline-container">
        <div class="timeline" id="timeline"></div>
    </div>
    <div class="info-button" id="infoButton">i</div>
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="close-button" id="closeButton">&times;</button>
            <div class="modal-inner">
                <h1>èª¤å­—ãƒ­ãƒã®æ—¥è¨˜</h1>

                <h2>ãªã‚“ã ã€ã“ã®æ—¥è¨˜ã¯ï¼Ÿ</h2>
                <p>ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ—¥è¨˜ã¯ã€åŒ—é–¢æ±ã®æŸæ‰€ã§ç”Ÿãã‚‹ã²ã¨ã‚Šã®äººé–“ãŒã€ãã®æ—¥ã®å‡ºæ¥äº‹ã‚„æ€ã£ãŸã“ã¨ã‚’æ°—è»½ã«ã€ã‹ã¤ç„¡è²¬ä»»ã«æ›¸ãç¶šã‘ã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚</p>
                <p>ç”»é¢å³ä¸Šã®<span
                        id="page-title-inmodal">èª¤å­—ãƒ­ãƒã®æ—¥è¨˜</span>ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç”»é¢ãŒæš—è»¢ã—ã€ã€Œå˜˜æ—¥è¨˜ã€ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚ã“ã“ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹å›ºæœ‰åè©ã¯ã€å®Ÿåœ¨ã™ã‚‹ã‚‚ã®ã¨å…¨ãé–¢ä¿‚ãŒã‚ã‚Šã¾ã›ã‚“ã®ã§ã”ç•™æ„ãã ã•ã„ã€‚å†åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Œæœ¬å½“æ—¥è¨˜ã€ã®è¡¨ç¤ºã«æˆ»ã‚Šã¾ã™ã€‚ãŸã ã—ã€æœ¬å½“ã®æ—¥è¨˜ã‚‚å¿…ãšã—ã‚‚äº‹å®ŸãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç­†è€…ã®èªè­˜ãŒã‚†ãŒã‚“ã§ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦ã€ã‚ãã¾ã§å¨¯æ¥½ã¨ã—ã¦ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
                </p>

                <h2>ãŠãŸã‚ˆã‚Š</h2>
                <p>æ—¥è¨˜ã®æ„Ÿæƒ³ã€è‡ªåˆ†èªã‚Šã€å°¿æ¼ã‚Œã®ãŠæ‚©ã¿ãªã©ã€<input type="text" id="mailSubject"
                        placeholder="ãŠå¥½ããªè‹±æ•°å­—">@poet.blueã¾ã§ã€æ°—è»½ã«ãŠé€ã‚Šãã ã•ã„ã€‚ãªãŠã€ãƒ¡ãƒ¼ãƒ«ã¸ã®è¿”ä¿¡ã¯æ°—åˆ†æ¬¡ç¬¬ã§ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚å ´åˆã«ã‚ˆã£ã¦ã¯æ—¥è¨˜ã®æ—¥ä»˜ä¸‹éƒ¨ã«ã€ŒğŸ“®ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­ç½®ã—ã€ãŠè¿”äº‹ãƒšãƒ¼ã‚¸ã®æ²è¼‰ã‚’ã‚‚ã£ã¦ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚
                </p>
                <textarea id="mailBody" placeholder="ä¾‹:â—‹æœˆÃ—æ—¥ã®ã€ã€‡ã€‡ã€ã¨ã„ã†éƒ¨åˆ†ã‚’èª­ã‚“ã§ã€â–³â–³ã‚’æ€ã„å‡ºã—ã¾ã—ãŸã€‚"></textarea>
                <div class="modal-buttons">
                    <button class="modal-button" id="sendMailButton">é€ã‚‹ä¸€æ­©æ‰‹å‰</button>
                </div>

                <h2>çŸ¥äººã«çŸ¥ã‚‰ã›ã‚‹</h2>
                <p>æ°—åˆ†ãŒãµã•ãŒã£ã¦ã„ã‚‹ã€æš‡ã‚’æŒã¦ä½™ã—ã¦ã„ã‚‹ã€ä½•ã‹ç„¡æ–™ã§èª­ã¿ãŸã„ã¨ã„ã†æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ã“ã®æ—¥è¨˜ã‚’ã”ç´¹ä»‹ãã ã•ã„ã€‚</p>
                <img src="https://i.imgur.com/BxnlTB4.png" alt="QRã‚³ãƒ¼ãƒ‰" class="qr">
                <center>
                    <p>https://nikki.poet.blue</p>
                </center>
                <button class="share-button" id="shareButton">å…±æœ‰ã™ã‚‹</button>

                <h2>Buy me a pen</h2>
                <p>ä»Šæ—¥ã¯çã—ãé¢ç™½ã‹ã£ãŸï¼ã¨ã‹ã€ãªã‚“ã‹æ©Ÿå«ŒãŒè‰¯ã‹ã£ãŸã€ã¨ã„ã†æ—¥ã«ãœã²ï¼
                </p>
                <a href="https://www.buymeacoffee.com/gojiroma" target="_blank" class="noskew"><img
                        src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
                        style="height: 60px !important;width: 217px !important;"></a>
            </div>
        </div>
    </div>
    <script>
        class DiaryUtils {
            static toKanjiNumber(num) {
                const kanjiNumbers = ['ã€‡', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
                return num.toString().split('').map(digit => kanjiNumbers[digit]).join('');
            }

            static toKanjiMonth(month) {
                const kanjiMonths = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                return kanjiMonths[month - 1];
            }

            static toKanjiDay(day) {
                const days = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå', 'äºŒåä¸€', 'äºŒåäºŒ', 'äºŒåä¸‰', 'äºŒåå››', 'äºŒåäº”', 'äºŒåå…­', 'äºŒåä¸ƒ', 'äºŒåå…«', 'äºŒåä¹', 'ä¸‰å', 'ä¸‰åä¸€'];
                return days[day];
            }

            static toJapaneseEra(year) {
                const eras = [
                    { name: 'ä»¤å’Œ', start: 2019, offset: 2018 },
                    { name: 'å¹³æˆ', start: 1989, offset: 1988 },
                    { name: 'æ˜­å’Œ', start: 1926, offset: 1925 },
                    { name: 'å¤§æ­£', start: 1912, offset: 1911 },
                    { name: 'æ˜æ²»', start: 1868, offset: 1867 }
                ];
                const era = eras.find(e => year >= e.start);
                const eraYear = year - era.offset;
                return `${era.name}${this.toKanjiNumber(eraYear)}å¹´`;
            }

            static formatJapaneseDate(yyyymmdd) {
                const year = parseInt(yyyymmdd.substring(0, 4), 10);
                const month = parseInt(yyyymmdd.substring(4, 6), 10);
                const day = parseInt(yyyymmdd.substring(6, 8), 10);
                const date = new Date(year, month - 1, day);
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                return {
                    short: `${this.toKanjiMonth(month)}${this.toKanjiDay(day)}æ—¥ï¼ˆ${DiaryApp.isFakeMode ? 'å˜˜' : dayOfWeek}ï¼‰`,
                    long: `${this.toJapaneseEra(year)}${this.toKanjiMonth(month)}${this.toKanjiDay(day)}æ—¥ï¼ˆ${DiaryApp.isFakeMode ? 'å˜˜' : dayOfWeek}ï¼‰`
                };
            }

            static calculateDaysAgo(yyyymmdd) {
                const entryDate = new Date(
                    parseInt(yyyymmdd.substring(0, 4), 10),
                    parseInt(yyyymmdd.substring(4, 6), 10) - 1,
                    parseInt(yyyymmdd.substring(6, 8), 10)
                );
                const today = new Date();
                const diffTime = today - entryDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return diffDays === 0 ? 'ä»Šæ—¥' : `${diffDays}æ—¥å‰`;
            }

            static escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

        }

        class DiaryApp {
            static isFakeMode = false;
            static fakeEntriesCache = null;
            static diaryEntries = [];
            static iconsData = [];
            static audioContext = null;

            static async init() {
                await this.loadIconsData();
                await this.loadDiaryEntries();
                this.preloadFakeEntries();
                this.setupEventListeners();
                this.setupModal();
                document.body.style.opacity = 1;
                setTimeout(startFallingAnimation, 180000); // 3åˆ†å¾Œã«å®Ÿè¡Œ
            }

            static async loadIconsData() {
                try {
                    const response = await fetch('icons.csv');
                    if (!response.ok) throw new Error(`Failed to load icons.csv: ${response.status}`);
                    const csv = await response.text();
                    this.iconsData = this.parseCSV(csv);
                } catch (error) {
                    console.error('Error loading icons.csv:', error);
                }
            }

            static parseCSV(csv) {
                const lines = csv.split('\n').filter(line => line.trim());
                return lines.slice(1).map(line => {
                    const [date, title, icon, url] = line.split(',').map(v => v.trim());
                    return { date, title, icon, url };
                });
            }

            static getIconsForDate(dateForIcons, keyword = '') {
                const icons = this.iconsData.filter(icon => icon.date === dateForIcons);
                if (icons.length === 0) return '';

                return icons.map(icon => {
                    const isUrl = icon.icon && (icon.icon.startsWith('http://') || icon.icon.startsWith('https://'));
                    const iconContent = isUrl
                        ? `<img src="${icon.icon}" alt="${icon.title}" class="icon-img" loading="lazy">`
                        : `<span class="icon-emoji">${icon.icon}</span>`;
                    const tooltip = icon.title ? `<div class="tooltip">${icon.title}</div>` : '';
                    const urlAttr = icon.url ? `onclick="window.open('${icon.url}', '_blank')" style="cursor: pointer;"` : '';
                    const highlightClass = keyword && icon.title.toLowerCase().includes(keyword.toLowerCase()) ? 'highlight' : '';
                    return `<div class="icon ${highlightClass}" ${urlAttr}>${iconContent}${tooltip}</div>`;
                }).join('');
            }

            static setupEventListeners() {
                const pageTitle = document.getElementById('pageTitle');
                pageTitle.addEventListener('click', () => this.toggleFakeMode());

                let pressTimer;
                pageTitle.addEventListener('mousedown', () => pressTimer = setTimeout(() => this.downloadDiaryAsText(), 1000));
                pageTitle.addEventListener('mouseup', () => clearTimeout(pressTimer));
                pageTitle.addEventListener('mouseleave', () => clearTimeout(pressTimer));

                document.addEventListener('keydown', e => this.handleKeyDown(e));
                window.addEventListener('hashchange', () => this.scrollToEntryFromHash());
                window.addEventListener('load', () => this.scrollToEntryFromHash());
            }

            static setupModal() {
                const infoButton = document.getElementById('infoButton');
                const modalOverlay = document.getElementById('modalOverlay');
                const closeButton = document.getElementById('closeButton');
                const sendMailButton = document.getElementById('sendMailButton');
                const shareButton = document.getElementById('shareButton');

                infoButton.addEventListener('click', () => {
                    modalOverlay.style.display = 'flex';
                    setTimeout(() => modalOverlay.classList.add('show'), 10);
                });

                closeButton.addEventListener('click', () => {
                    modalOverlay.classList.remove('show');
                    setTimeout(() => modalOverlay.style.display = 'none', 300);
                });

                modalOverlay.addEventListener('click', e => {
                    if (e.target === modalOverlay) {
                        modalOverlay.classList.remove('show');
                        setTimeout(() => modalOverlay.style.display = 'none', 300);
                    }
                });

                sendMailButton.addEventListener('click', () => {
                    const subject = document.getElementById('mailSubject').value || 'somebody';
                    const body = document.getElementById('mailBody').value || 'æœ¬æ–‡ãªã—';
                    window.location.href = `mailto:${subject}@poet.blue?subject=èª¤å­—ãƒ­ãƒã®æ—¥è¨˜ã‚’èª­ã¿ã¾ã—ãŸ&body=${encodeURIComponent(body)}`;
                });

                shareButton.addEventListener('click', () => {
                    if (navigator.share) {
                        navigator.share({ title: 'èª¤å­—ãƒ­ãƒã®æ—¥è¨˜', url: 'https://nikki.poet.blue' });
                    } else {
                        alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„: https://nikki.poet.blue');
                    }
                });
            }

            static async loadDiaryEntries(filename = 'entry.md') {
                try {
                    const response = await fetch(filename);
                    if (!response.ok) throw new Error(`Failed to load ${filename}: ${response.status}`);
                    const text = await response.text();
                    this.renderEntries(text);
                } catch (error) {
                    console.error(`Error loading ${filename}:`, error);
                }
            }

            static renderEntries(text) {
                const container = document.getElementById('diaryContainer');
                container.innerHTML = '';
                this.diaryEntries = [];

                const entries = text.split('---').filter(entry => entry.trim());
                entries.reverse().forEach(entry => {
                    const dateMatch = entry.match(/date:\s*(.*)/);
                    const contentMatch = entry.match(/content:\s*\|\n([\s\S]*?)(?=\n---|\n$)/m);
                    if (!dateMatch || !contentMatch) return;

                    const yyyymmdd = dateMatch[1].trim();
                    const dateObj = DiaryUtils.formatJapaneseDate(yyyymmdd);
                    const contentLines = contentMatch[1].split('\n').map(line => line.replace(/^\s*\|?\s*/, '')).join('\n');
                    const dateForIcons = `${yyyymmdd.substring(0, 4)}/${yyyymmdd.substring(4, 6)}/${yyyymmdd.substring(6, 8)}`;
                    const iconsHTML = this.getIconsForDate(dateForIcons);

                    const entryElement = document.createElement('div');
                    entryElement.className = 'diary-entry';
                    entryElement.id = yyyymmdd;
                    entryElement.innerHTML = `
                            <div class="date-container">
                                <div class="date" data-yyyymmdd="${yyyymmdd}">${dateObj.short}</div>
                                <div class="days-ago">${DiaryUtils.calculateDaysAgo(yyyymmdd)}</div>
                                ${iconsHTML}
                            </div>
                            <div class="content">${contentLines}</div>
                        `;
                    container.appendChild(entryElement);

                    this.diaryEntries.push({
                        yyyymmdd,
                        content: contentLines.trim(),
                        icons: this.iconsData.filter(icon => icon.date === dateForIcons)
                    });
                });

                this.setupDateClick();
                this.renderTimeline();
                this.updatePageTitle(entries.length);
                this.scrollToEntryFromHash();
            }

            static setupDateClick() {
                document.querySelectorAll('.date').forEach(dateElement => {
                    dateElement.addEventListener('click', () => {
                        window.location.hash = dateElement.getAttribute('data-yyyymmdd');
                    });
                });
            }

            static renderTimeline() {
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';

                if (this.diaryEntries.length === 0) return;

                const sortedEntries = [...this.diaryEntries].sort((a, b) => a.yyyymmdd.localeCompare(b.yyyymmdd));
                const contentLengths = sortedEntries.map(entry => entry.content.length);
                const maxContentLength = Math.min(this.percentile95(contentLengths), 500);
                const baseHeight = 5;
                const heightRatio = 45 / maxContentLength;

                sortedEntries.forEach(entry => {
                    const container = document.createElement('div');
                    container.className = 'timeline-bar';
                    container.dataset.yyyymmdd = entry.yyyymmdd;
                    container.title = `${entry.yyyymmdd}: ${entry.content.length}æ–‡å­—`;
                    const innerBar = document.createElement('div');
                    innerBar.className = 'timeline-bar-inner';
                    const contentLength = Math.min(entry.content.length, maxContentLength);
                    innerBar.style.height = `${Math.max(baseHeight, contentLength * heightRatio)}px`;

                    container.addEventListener('mouseover', () => {
                        window.location.hash = entry.yyyymmdd;
                        this.scrollToEntryFromHash();
                    });

                    container.addEventListener('touchstart', e => {
                        e.preventDefault();
                        window.location.hash = entry.yyyymmdd;
                        this.scrollToEntryFromHash();
                    });

                    container.appendChild(innerBar);
                    timeline.appendChild(container);
                });

                const hash = window.location.hash.substring(1);
                if (hash && hash.match(/^\d{8}$/)) {
                    const selectedBar = document.querySelector(`.timeline-bar[data-yyyymmdd="${hash}"]`);
                    if (selectedBar) selectedBar.classList.add('selected');
                }

                timeline.addEventListener('touchmove', e => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = timeline.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const percent = x / rect.width;
                    const index = Math.floor((1 - percent) * sortedEntries.length);
                    if (index >= 0 && index < sortedEntries.length) {
                        window.location.hash = sortedEntries[index].yyyymmdd;
                        this.scrollToEntryFromHash();
                    }
                }, { passive: false });
            }

            static percentile95(arr) {
                const sorted = [...arr].sort((a, b) => a - b);
                return sorted[Math.floor(sorted.length * 0.95)];
            }

            static toggleFakeMode() {
                this.isFakeMode = !this.isFakeMode;
                const title = document.querySelector('.page-title');
                const body = document.body;

                title.textContent = this.isFakeMode ? 'èª¤å­—ãƒ­ãƒã®å˜˜æ—¥è¨˜' : 'èª¤å­—ãƒ­ãƒã®æ—¥è¨˜';
                title.classList.toggle('fake-mode', this.isFakeMode);
                body.classList.toggle('fake-mode', this.isFakeMode);

                if (this.isFakeMode) {
                    if (this.fakeEntriesCache) {
                        this.renderEntries(this.fakeEntriesCache);
                    } else {
                        this.loadDiaryEntries('fake.md');
                    }
                } else {
                    this.loadDiaryEntries('entry.md');
                }
            }

            static async preloadFakeEntries() {
                try {
                    const response = await fetch('fake.md');
                    if (response.ok) this.fakeEntriesCache = await response.text();
                } catch (error) {
                    console.error('Error preloading fake entries:', error);
                }
            }

            static scrollToEntryFromHash() {
                this.playBeep(340, 0.1);
                requestAnimationFrame(() => {
                    const hash = window.location.hash.substring(1);
                    const container = document.getElementById('diaryContainer');
                    const entries = document.querySelectorAll('.diary-entry');
                    const timelineBars = document.querySelectorAll('.timeline-bar');

                    timelineBars.forEach(bar => bar.classList.remove('selected'));

                    if (hash && hash.match(/^\d{8}$/)) {
                        const entry = document.getElementById(hash);
                        if (entry) {
                            const entryRight = entry.offsetLeft + entry.clientWidth;
                            const containerWidth = container.clientWidth;
                            this.smoothScrollTo(container, entryRight - containerWidth);

                            const selectedBar = document.querySelector(`.timeline-bar[data-yyyymmdd="${hash}"]`);
                            if (selectedBar) selectedBar.classList.add('selected');
                        }
                    } else if (entries.length > 0) {
                        const latestEntry = entries[0];
                        const entryRight = latestEntry.offsetLeft + latestEntry.clientWidth;
                        const containerWidth = container.clientWidth;
                        this.smoothScrollTo(container, entryRight - containerWidth);
                    }
                });
            }

            static smoothScrollTo(element, targetPosition, duration = 50) {
                const startPosition = element.scrollLeft;
                const startTime = performance.now();

                const animateScroll = currentTime => {
                    const elapsedTime = currentTime - startTime;
                    const progress = Math.min(elapsedTime / duration, 1);
                    element.scrollLeft = startPosition + (targetPosition - startPosition) * progress;
                    if (progress < 1) requestAnimationFrame(animateScroll);
                };

                requestAnimationFrame(animateScroll);
            }

            static handleKeyDown(e) {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    const currentEntry = this.getCurrentEntry();
                    if (!currentEntry) return;

                    const direction = e.key === 'ArrowLeft' ? -1 : 1;
                    const nextEntry = this.getAdjacentEntry(currentEntry, direction);
                    if (nextEntry) {
                        window.location.hash = nextEntry.id;
                        this.scrollToEntryFromHash();
                    }
                } else if (e.key === 'Escape' && window.location.hash) {
                    window.location.hash = '';
                }
            }

            static getCurrentEntry() {
                const hash = window.location.hash.substring(1);
                if (hash && hash.match(/^\d{8}$/)) return document.getElementById(hash);

                const entries = document.querySelectorAll('.diary-entry');
                return entries.length > 0 ? entries[0] : null;
            }

            static getAdjacentEntry(currentEntry, direction) {
                const entries = document.querySelectorAll('.diary-entry');
                const currentIndex = Array.from(entries).indexOf(currentEntry);
                if (currentIndex === -1) return null;

                const nextIndex = currentIndex + direction;
                if (nextIndex < 0 || nextIndex >= entries.length) return null;
                return entries[nextIndex];
            }

            static downloadDiaryAsText() {
                if (this.diaryEntries.length === 0) return alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');

                const sortedEntries = [...this.diaryEntries].sort((a, b) => a.yyyymmdd.localeCompare(b.yyyymmdd));
                const oldestDate = sortedEntries[0].yyyymmdd;
                const newestDate = sortedEntries[sortedEntries.length - 1].yyyymmdd;
                const modePrefix = this.isFakeMode ? 'å˜˜æ—¥è¨˜_' : '';
                const filename = `${modePrefix}èª¤å­—ãƒ­ãƒã®æ—¥è¨˜ ${oldestDate}-${newestDate}.txt`;

                let content = '';
                sortedEntries.forEach(entry => {
                    const dateObj = DiaryUtils.formatJapaneseDate(entry.yyyymmdd);
                    content += `${dateObj.long}\n${entry.content}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            static updatePageTitle(count) {
                const pageTitle = document.getElementById('pageTitle');
                const pageInModalTitle = document.getElementById('page-title-inmodal');
                pageTitle.textContent = `èª¤å­—ãƒ­ãƒã®${count}æ—¥é–“`;
                pageInModalTitle.textContent = `èª¤å­—ãƒ­ãƒã®${count}æ—¥é–“`;
            }

            static async playBeep(frequency = 440, duration = 0.1) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    await this.audioContext.resume();
                } else if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                gainNode.gain.value = 0.1;
                gainNode.gain.exponentialRampToValueAtTime(0.0001, this.audioContext.currentTime + duration);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        DiaryApp.init();
    </script>
    <script>
        const wrapCharsForFalling = () => {
            document.querySelectorAll('.content').forEach(content => {
                const text = content.textContent;
                let wrapped = '';
                for (let i = 0; i < text.length; i++) {
                    wrapped += `<span class="char">${text[i]}</span>`;
                }
                content.innerHTML = wrapped;
            });
        };

        const startFallingAnimation = () => {
            wrapCharsForFalling();
            const chars = document.querySelectorAll('.char');
            const dates = document.querySelectorAll('.date');

            const animateFalling = (element, rect) => {
                const delay = Math.random() * 3100;
                const randomXOffset = (Math.random() - 0.5) * window.innerWidth * 0.6;
                const randomYOffset = Math.random() * -window.innerHeight * 0.83;
                const startTop = window.innerHeight + randomYOffset;
                const startLeft = rect.left + randomXOffset;
                const angle = (Math.random() * 63) - 34;
                const duration = 1 + Math.random() * 72;
                const landingPosition = window.innerHeight * 0.9 + Math.random() * 1200;

                setTimeout(() => {
                    element.style.position = 'fixed';
                    element.style.left = `${startLeft}px`;
                    element.style.top = `${startTop}px`;
                    element.style.transform = `rotate(${angle}deg)`;
                    element.style.opacity = '1';
                    element.classList.add('falling');

                    setTimeout(() => {
                        element.style.transition = `transform ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                        element.style.transform = `rotate(${angle + (Math.random() * 20 - 10)}deg) translateY(${landingPosition - startTop}px)`;
                    }, 10);
                }, delay);
            };

            chars.forEach(char => {
                const rect = char.getBoundingClientRect();
                animateFalling(char, rect);
            });

            dates.forEach(date => {
                const rect = date.getBoundingClientRect();
                animateFalling(date, rect);
            });
        };
    </script>

</body>

</html>